<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Godot Engine"><meta name=description content="After all the light types are implemented, the next step is to implement shadow mapping, with all its frustrating implementation details ;)"><meta name=theme-color content="#3d8fcc"><meta property="og:site_name" content="Godot Engine"><meta property="og:url" content="https://godotengine.org/article/gles2-and-gdnative-progress-report-7/"><meta name=twitter:site content="@godotengine"><meta property="og:title" content="GLES2 and GDNative, progress report #7"><meta property="og:description" content="After all the light types are implemented, the next step is to implement shadow mapping, with all its frustrating implementation details ;)"><meta property="og:image" content="https://godotengine.org/storage/app/uploads/public/5b5/59c/e48/5b559ce4849ad017013962.png"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><title>GLES2 and GDNative, progress report #7</title><link rel=alternate type=application/rss+xml title="Godot News" href=/rss.xml><link rel=icon href=/assets/favicon.png sizes=any><link rel=icon href=/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=/assets/css/main.css?112><link rel=stylesheet href=/assets/css/tobii.min.css><link rel=preload as=font href=/assets/fonts/Montserrat-Bold.woff2 crossorigin><link rel=preload as=font href=/assets/fonts/Montserrat-ExtraBold.woff2 crossorigin><link rel=me href=https://mastodon.gamedev.place/@godotengine><input type=checkbox id=nav_toggle_cb><header><div class="container flex align-center"><div id=nav_head><a href=/ id=logo-link><img class=nav-logo src=/assets/logo.svg width=136 height=48 alt="Godot Engine">
<img class="nav-logo dark-logo" src=/assets/logo_dark.svg width=136 height=48 alt="Godot Engine"></a>
<label for=nav_toggle_cb id=nav_toggle_btn><img src=/assets/icons/hamburger.svg width=24 height=24 alt="Main menu"></label></div><nav id=nav><ul class=left><li><a href=/features/>Features</a><li class=only-on-mobile><a href=/showcase/>Showcase</a><li><a href=/blog/>Blog</a><li><a href=/community/>Community</a><li><a href=/contact/>About</a><li><a href=https://godotengine.org/asset-library/asset>Assets</a></ul><ul class=right><li><a href=/download/windows/ class=set-os-download-url>Download</a><li><a href=https://docs.godotengine.org>Docs</a><li><a href=https://docs.godotengine.org/en/stable/community/contributing/index.html>Contribute</a><li class=fund><a href=https://fund.godotengine.org>❤&#xFE0E; Donate</a></ul></nav></div></header><main><style>body{background-color:var(--background-color)}h1{margin-bottom:8px;margin-top:32px}:not(pre)>code{background:var(--code-background-color);padding:1px 4px;font-size:.95em;border-radius:3px}pre{background:var(--codeblock-background-color);color:var(--codeblock-color)}pre code{display:block;overflow-x:auto;padding:.5em}.date-big{line-height:2;margin-left:32px}article{background-color:var(--base-color);box-shadow:0 3px 2px rgba(0,0,0,.15)}figure{margin:0}figure img{margin:0}article img,article video{max-width:100%;height:auto;display:block;margin:auto;margin-top:16px;margin-bottom:16px}article h1{margin-top:64px}article h2,article h3,article h4{margin-top:42px}.article-info{display:flex;flex-direction:column;gap:8px}.article-metadata{display:flex;gap:24px;align-items:center;font-family:var(--header-font-family);margin-bottom:12px}@media(max-width:900px){.article-metadata{flex-direction:column;align-items:flex-start;gap:16px}}.article-author{color:var(--base-color-text-subtitle-date);font-weight:700;font-size:18px;flex-grow:1;display:flex;gap:12px;align-items:center}.article-author .avatar{border-radius:100%;margin:0}.article-author .by{color:var(--base-color-text-subtitle)}.article-metadata .date{color:var(--base-color-text-subtitle-date)}.article-metadata .date.post-recent-highlight{color:var(--post-recent-highlight-color);opacity:.8}.article-metadata .date.post-recent-highlight::after{font-size:80%;content:"NEW";border:2px solid var(--post-recent-highlight-color);padding:2px 3px;margin-left:8px}.tag.active{filter:saturate(.75)}@media screen and (min-width:900px){article .content{width:70%;margin:auto}}@media(max-width:900px){body{background-color:var(--base-color)}article{background-color:initial;box-shadow:none}article img:first-child,article video:first-child{max-width:100%}}</style><link rel=stylesheet href=/assets/css/highlight.obsidian.min.css><div class=container><article class=padded><div class="content article-container"><figure class=article-cover><img src=/storage/app/uploads/public/5b5/59c/e48/5b559ce4849ad017013962.png title alt=" " class=rounded-lg style=width:100%;height:auto;background-color:initial></figure><div class=article-info><h1>GLES2 and GDNative, progress report #7</h1><div class=article-metadata><div class=article-author><span>By:</span>
<img class=avatar width=25 height=25 src=/assets/images/authors/default_avatar.svg alt=karroffel loading=lazy>
<span class=by>karroffel</span></div><span class=date data-post-date="2018-07-23 00:00:00 +0000">23 July 2018</span></div><div class=tags><a href=/blog/progress-report><div class="tag active">Progress Report</div></a></div></div><div class="card card-warning"><p>This article is from <strong>July 2018</strong>, some of its contents might be outdated and no longer accurate.<br>You can find up-to-date information about the engine in the <a href=https://docs.godotengine.org/en/stable/>official documentation</a>.</div><div class=article-body><h2 id=introduction>Introduction</h2><p>After all the light types are implemented, the next step is to implement shadow mapping, with all its frustrating implementation details ;)<h2 id=roadmap>Roadmap</h2><h4 id=done-june-2018>Done June 2018</h4><ul><li>finish lights<li>implement shadow atlas<li>depth rendering for shadow mapping<li>spot light shadows<li>omni light shadows<li>billboard support in shaders and editor fixes<li>BlendSpace1D</ul><h4 id=planned-july-2018>Planned July 2018</h4><ul><li>directional shadows<li>reflection probes<li>lightmaps<li>particles<li>implement immediate geometry<li>merge into master branch</ul><h2 id=details-about-work-in-june-2018>Details about work in June 2018</h2><h3 id=finish-lights>finish lights</h3><p>At the end of May, <code class="language-plaintext highlighter-rouge">OmniLight</code>s were already working, so the other types of light sources need to be implemented as well.<p>The first thing I tackled were <code class="language-plaintext highlighter-rouge">SpotLight</code>s. A SpotLight is pretty much just an OmniLight (so it just emits light in a circular way around it) but the light is restricted to a cone.<p><img src=/storage/app/uploads/public/5b5/589/a49/5b5589a49cc01310770344.png alt=Screenshot_2018-07-23_09-53-40.png><p>The last light type missing was <code class="language-plaintext highlighter-rouge">DirectionalLight</code>, which is usually used to emulate a star or a very far away light source.
All this light needs to be described is the direction of the light, no position is needed.<p><img src=/storage/app/uploads/public/5b5/58a/8cc/5b558a8cc9034494048418.png alt=Screenshot_2018-07-23_09-57-45.png><p>The shader code for the lights can be found <a href=https://github.com/karroffel/godot/blob/157da9a7c36eeaf1326708ed7432a2311a28032f/drivers/gles2/shaders/scene.glsl#L474-L614>here</a>.<h3 id=implement-shadow-atlas>implement shadow atlas</h3><p>With that, simple illumination was working, but there were no shadows yet!<p>I will go more in-depth about shadow-mapping later, for now just know that in order to show shadows, the scene needs to be rendered from the perspective of each light and the result has to be saved.<p>Different lights need different storage types.<p>Since directional lights span <strong>the whole scene</strong>, they need their own separate storage that’s big enough for all this.<p><code class="language-plaintext highlighter-rouge">SpotLight</code>s have a restriction on the angle of the cone, so it can never span more than a half-circle. This means all it needs is a single “image” that shows the space that the light can reach. The higher the angle the more stretched by perspective it will be, but this works just fine.<p><code class="language-plaintext highlighter-rouge">OmniLight</code>s need more information than just a single view. They reach around in a spherical way, so what the GLES2 backend does is render into a <a href=https://en.wikipedia.org/wiki/Cube_mapping>cubemap</a> (6 images, arranged like the faces of a cube). Because using 6 images would take quite a lot of storage space, the cubemap gets converted into a <em>“dual paraboloid”</em>, which is essentially like two fish-eye-lens pictures.<p>A <code class="language-plaintext highlighter-rouge">DirectionalLight</code> needs their own space, but using single textures for each other light would be pretty wasteful, so what is used as an optimization is a <em>Shadow Atlas</em>. Using a ShadowAtlas lets us pack multiple images into one, and even give them more or less space depending on distance from the camera to achieve better detail.<p>There is a nice article about lights and shadows on the documentation pages, you can find it <a href=http://docs.godotengine.org/en/3.0/tutorials/3d/lights_and_shadows.html#shadow-atlas>here</a>.<p>For the GLES2 renderer, I had to implement the interface for those shadow atlases. This was mostly coding in “the dark”, so there is not much to show <em>yet</em>. The code is located <a href=https://github.com/karroffel/godot/blob/157da9a7c36eeaf1326708ed7432a2311a28032f/drivers/gles2/rasterizer_scene_gles2.cpp#L55-L389>here</a>.<h3 id=depth-rendering-for-shadow-mapping>depth rendering for shadow mapping</h3><p>As mentioned before, in order to know which pixels are “in a shadow” and which are lit, the scene has to be rendered from the viewpoint of the light.<p>But this is not a regular render pass, we are only interested in the <a href=https://en.wikipedia.org/wiki/Z-buffering><em>depth buffer</em></a>.<p>When the <code class="language-plaintext highlighter-rouge">VisualServer</code> (the high level render abstraction) calls the renderer, it passes a flag if this draw pass is depth only or a regular call.<p>A few adjustments and optimizations had to be done to support this properly without wasting computation power.<p>The result of these draw calls get rendered directly into a shadow atlas or the directional shadow storage.<p>So now the shadow atlas can actually be visualized!<p><img src=/storage/app/uploads/public/5b5/593/db7/5b5593db79d7a030918073.png alt=L9L6ETQ.png><p>I zoomed out and in when taking this picture, so I could see that the allocation works correctly. But for now everything is white? Shouldn’t there be the sphere in greyscale? The problem here is that the depth buffer wasn’t <em>linearized</em>, so in order to see if the rendering was actually working I needed to bring the light <strong>veeeeeery</strong> close.<p><img src=/storage/app/uploads/public/5b5/594/f7c/5b5594f7cfd5f912083002.png alt=R6JSjSn.png><p>So after coding in the dark for quite a while, the darkness is finally visualized :)<h3 id=spot-light-shadows>spot light shadows</h3><p>Next on the list - actually do something with those depth renderings.<p>Each pixel that gets <em>potentially</em> illuminated by the light source has to check if it’s in a shadow or not. How is that done?<p>If there’s a transformation that brings us from object’s coordinates into screen-coordinates, then there’s an inverse that lets us calculate the object-coordinates from the screen-coordinates. Then we can apply the shadow transform to see where that point would end up in the depth rendering.<p>If the “light depth” of that pixel is “behind” the thing that we rendered, we know that it’s in a shadow.<p>That’s a lot of <em>transforms</em> and coordinates and all that. The basic principle is that there is a check to see if something is between the light and the current pixel or not. That’s all :)<p>Sounds easy enough, but in practice it took me maaaaany hours of debugging and guesswork. But, as usual, it made for some nice screenshots.<p><img src=/storage/app/uploads/public/5b5/596/a6d/5b5596a6d5f6d253558345.jpg alt=OINPD16.jpg><p>Eventually it worked out… more or less.<p><img src=/storage/app/uploads/public/5b5/596/ed7/5b5596ed7c099658849260.png alt="Screenshot from 2018-06-22 12-59-55.png"><p>I solved this problem too but didn’t take a screenshot afterwards. Just believe me that it was a relief after so many hours of debugging :D<h3 id=omni-light-shadows>omni light shadows</h3><p>As mentioned, <code class="language-plaintext highlighter-rouge">OmniLight</code>s use a different way of storing the depth information, but really only the transforms change a little. So after all those countless hours getting the <code class="language-plaintext highlighter-rouge">SpotLight</code>s working, making <code class="language-plaintext highlighter-rouge">OmniLight</code>s work was pretty fast.<p><img src=/storage/app/uploads/public/5b5/597/940/5b5597940825e150760884.png alt="Screenshot from 2018-06-28 12-41-01.png"><p>(In the ShadowAtlas debug view you can see the fish-eye projection for <code class="language-plaintext highlighter-rouge">OmniLight</code>s)<p>All together it works pretty nicely, some things still need some ironing (mostly “shadowmap filtering”), but the biggest step was taken :)<p><img src=/storage/app/uploads/public/5b5/597/ff9/5b5597ff964fa910401532.png alt="Screenshot from 2018-06-28 13-20-56.png"><h3 id=billboard-support-in-shaders-and-editor-fixes>billboard support in shaders and editor fixes</h3><p>Since Godot’s goal is to be as flexible as possible without comprimising usability there are a lot of knobs and switches to take care of in the rendering code.
One of those things was support for “billboard modes” and for the vertex shader to skip the vertex transform so the user can do it manually.<p>This made many more gizmos in the editor show up, so now it is almost as complete as the GLES3 version of the editor, with the exception for things that use <code class="language-plaintext highlighter-rouge">ImmediateGeometry</code>, like some handles on light gizmos. Implementing this is planned for next month :)<h3 id=blendspace1d>BlendSpace1D</h3><p>To catch some breath after all this debugging madness, I took a shot at implementing <code class="language-plaintext highlighter-rouge">BlendSpace1D</code> for the new animation system since I needed that in one of my side-projects.<p><img src=/storage/app/uploads/public/5b5/598/dc0/5b5598dc0ada4668331903.png alt="Screenshot from 2018-06-22 19-31-03.png"><p>You can read more about the new animation system <a href=https://godotengine.org/article/godot-gets-new-animation-tree-state-machine>here</a>!<p>The code for that can be found <a href=https://github.com/godotengine/godot/blob/17b44e44b9a34e540cf48ee0a7335ecefcd0c3b7/scene/animation/animation_blend_space_1d.cpp>here</a>.<h2 id=future>Future</h2><p>The way the lighting is done currently is very bad for the i-cache of the GPU, so some refactoring will be needed to increase performance.<p>Also the branch will soon be merged into the Godot <code class="language-plaintext highlighter-rouge">master</code> branch, so some cleanup will be done for that as well.<h2 id=seeing-the-code>Seeing the code</h2><p>If you are interested in the GLES2 related code, you can see all the commits in my <a href=https://github.com/karroffel/godot/tree/gles2>fork</a> on GitHub. Other contributions are linked in the sections above.</div></div></article></div><link rel=stylesheet href=/assets/css/anchor-link.css?1><link rel=stylesheet href=/assets/css/article-cards.css?2><script src=/assets/js/anchor-link.js></script>
<script>document.addEventListener('DOMContentLoaded',()=>{window.applyAnchorLinks('.article-body'),document.querySelectorAll('.article-cover img, .article-body img').forEach(b=>{if(b.classList.contains('lightbox-ignore'))return;const a=document.createElement('a');a.href=b.src,a.classList.add('lightbox'),a.dataset.group='article',b.parentNode.appendChild(a),a.appendChild(b)})})</script></main><footer><div class="container flex footer-container"><div id=copyright><p>© 2007-2024 Juan Linietsky, Ariel Manzur and <a href=https://github.com/godotengine/godot/blob/master/AUTHORS.md target=_blank rel=noopener>contributors</a>.<br>Hosted by the <a href=https://godot.foundation/ target=_blank rel=noopener>Godot Foundation</a>.<br>Website <a href=https://github.com/godotengine/godot-website target=_blank rel=noopener>source code on GitHub</a>.</div><div id=sitemap><ul class=sitemap-group><li><strong>Get Godot</strong><li><a href=/download/windows/ class=set-os-download-url>Download</a><li><a href=/download/archive/>Release Archive</a><li><a href=https://editor.godotengine.org/releases/latest/>Web Editor</a><li>&nbsp;<li><strong>Public Relations</strong><li><a href=/blog/>Blog</a><li><a href=/community/>Communities and Events</a><li><a href=/press/>Press Kit</a></ul><ul class=sitemap-group><li><strong>About Godot</strong><li><a href=/features/>Features</a><li><a href=/showcase/>Showcase</a><li><a href=/education/>Education</a><li><a href=/license/>License</a><li><a href=/code-of-conduct/>Code of Conduct</a><li><a href=/privacy-policy/>Privacy Policy</a><li><a href=https://fund.godotengine.org>Donate</a></ul><ul class=sitemap-group><li><strong>Project Team</strong><li><a href=/governance/>Governance</a><li><a href=/teams/>Teams</a><li>&nbsp;<li><strong>Extra Resources</strong><li><a href=https://godotengine.org/asset-library/asset>Asset Library</a><li><a href=https://docs.godotengine.org>Documentation</a><li><a href=https://github.com/godotengine>Code Repository</a></ul></div><div id=social class=dark-desaturate><h4 class=text-right><a href=/contact/>Contact us</a></h4><div class="flex justify-space-between" style=gap:3px><a href=https://github.com/godotengine target=_blank rel=noopener><img src=/assets/footer/github_logo.svg width=32 height=32 alt=GitHub></a>
<a href=https://mastodon.gamedev.place/@godotengine target=_blank rel=noopener><img src=/assets/footer/mastodon_logo.svg width=32 height=32 alt=Mastodon></a>
<a href=https://twitter.com/godotengine target=_blank rel=noopener><img src=/assets/footer/twitter_logo.svg width=32 height=32 alt=Twitter></a>
<a href=https://www.facebook.com/groups/godotengine/ target=_blank rel=noopener><img src=/assets/footer/facebook_logo.svg width=32 height=32 alt=Facebook></a>
<a href=https://www.reddit.com/r/godot target=_blank rel=noopener><img src=/assets/footer/reddit_logo.svg width=32 height=32 alt=Red​dit></a>
<a href=/rss.xml target=_blank rel=noopener><img src=/assets/footer/feed_logo.svg width=32 height=32 alt="RSS feed"></a></div></div></div></footer><script defer src=/assets/js/tobii.min.js></script>
<script defer src=/assets/js/highlight.min.js?1></script>
<script defer src=/assets/js/highlight.gdscript.min.js?1></script>
<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('pre code').forEach(a=>{hljs.highlightBlock(a)}),document.querySelectorAll('[data-post-date]').forEach(a=>{Date.parse(a.dataset.postDate)>Date.now()-1e3*60*60*48&&a.classList.add("post-recent-highlight")}),new Tobii({zoom:!1});const a=document.querySelectorAll('.set-os-download-url');for(let b=0;b<a.length;b++){const c=a[b];let e='download';'version'in c.dataset&&c.dataset.version==='3'&&(e='download/3.x');let d='windows';navigator.platform.indexOf('Mac')!==-1?d='macos':navigator.platform.indexOf('Linux')!==-1&&(d='linux'),c.href=`/${e}/${d}/`}})</script>