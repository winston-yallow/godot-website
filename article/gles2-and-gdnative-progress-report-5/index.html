<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Godot Engine"><meta name=description content="The progress of last month was largely defined by stabilizing the 3D renderer with many smaller fixes, but work on the PRB side of things has begun and the GDNative system also saw some quality-of-life changes again, with improvements to the GDNativeLibrary resource as well as an API to provide safe type-casting in NativeScript."><meta name=theme-color content="#3d8fcc"><meta property="og:site_name" content="Godot Engine"><meta property="og:url" content="https://godotengine.org/article/gles2-and-gdnative-progress-report-5/"><meta name=twitter:site content="@godotengine"><meta property="og:title" content="GLES2 and GDNative, progress report #5"><meta property="og:description" content="The progress of last month was largely defined by stabilizing the 3D renderer with many smaller fixes, but work on the PRB side of things has begun and the GDNative system also saw some quality-of-life changes again, with improvements to the GDNativeLibrary resource as well as an API to provide safe type-casting in NativeScript."><meta property="og:image" content="https://godotengine.org/storage/app/uploads/public/5af/0e5/72b/5af0e572bcfa6454445114.png"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><title>GLES2 and GDNative, progress report #5</title><link rel=alternate type=application/rss+xml title="Godot News" href=/rss.xml><link rel=icon href=/assets/favicon.png sizes=any><link rel=icon href=/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=/assets/css/main.css?112><link rel=stylesheet href=/assets/css/tobii.min.css><link rel=preload as=font href=/assets/fonts/Montserrat-Bold.woff2 crossorigin><link rel=preload as=font href=/assets/fonts/Montserrat-ExtraBold.woff2 crossorigin><link rel=me href=https://mastodon.gamedev.place/@godotengine><input type=checkbox id=nav_toggle_cb><header><div class="container flex align-center"><div id=nav_head><a href=/ id=logo-link><img class=nav-logo src=/assets/logo.svg width=136 height=48 alt="Godot Engine">
<img class="nav-logo dark-logo" src=/assets/logo_dark.svg width=136 height=48 alt="Godot Engine"></a>
<label for=nav_toggle_cb id=nav_toggle_btn><img src=/assets/icons/hamburger.svg width=24 height=24 alt="Main menu"></label></div><nav id=nav><ul class=left><li><a href=/features/>Features</a><li class=only-on-mobile><a href=/showcase/>Showcase</a><li><a href=/blog/>Blog</a><li><a href=/community/>Community</a><li><a href=/contact/>About</a><li><a href=https://godotengine.org/asset-library/asset>Assets</a></ul><ul class=right><li><a href=/download/windows/ class=set-os-download-url>Download</a><li><a href=https://docs.godotengine.org>Docs</a><li><a href=https://docs.godotengine.org/en/stable/community/contributing/index.html>Contribute</a><li class=fund><a href=https://fund.godotengine.org>❤&#xFE0E; Donate</a></ul></nav></div></header><main><style>body{background-color:var(--background-color)}h1{margin-bottom:8px;margin-top:32px}:not(pre)>code{background:var(--code-background-color);padding:1px 4px;font-size:.95em;border-radius:3px}pre{background:var(--codeblock-background-color);color:var(--codeblock-color)}pre code{display:block;overflow-x:auto;padding:.5em}.date-big{line-height:2;margin-left:32px}article{background-color:var(--base-color);box-shadow:0 3px 2px rgba(0,0,0,.15)}figure{margin:0}figure img{margin:0}article img,article video{max-width:100%;height:auto;display:block;margin:auto;margin-top:16px;margin-bottom:16px}article h1{margin-top:64px}article h2,article h3,article h4{margin-top:42px}.article-info{display:flex;flex-direction:column;gap:8px}.article-metadata{display:flex;gap:24px;align-items:center;font-family:var(--header-font-family);margin-bottom:12px}@media(max-width:900px){.article-metadata{flex-direction:column;align-items:flex-start;gap:16px}}.article-author{color:var(--base-color-text-subtitle-date);font-weight:700;font-size:18px;flex-grow:1;display:flex;gap:12px;align-items:center}.article-author .avatar{border-radius:100%;margin:0}.article-author .by{color:var(--base-color-text-subtitle)}.article-metadata .date{color:var(--base-color-text-subtitle-date)}.article-metadata .date.post-recent-highlight{color:var(--post-recent-highlight-color);opacity:.8}.article-metadata .date.post-recent-highlight::after{font-size:80%;content:"NEW";border:2px solid var(--post-recent-highlight-color);padding:2px 3px;margin-left:8px}.tag.active{filter:saturate(.75)}@media screen and (min-width:900px){article .content{width:70%;margin:auto}}@media(max-width:900px){body{background-color:var(--base-color)}article{background-color:initial;box-shadow:none}article img:first-child,article video:first-child{max-width:100%}}</style><link rel=stylesheet href=/assets/css/highlight.obsidian.min.css><div class=container><article class=padded><div class="content article-container"><figure class=article-cover><img src=/storage/app/uploads/public/5af/0e5/72b/5af0e572bcfa6454445114.png title alt=" " class=rounded-lg style=width:100%;height:auto;background-color:initial></figure><div class=article-info><h1>GLES2 and GDNative, progress report #5</h1><div class=article-metadata><div class=article-author><span>By:</span>
<img class=avatar width=25 height=25 src=/assets/images/authors/default_avatar.svg alt=karroffel loading=lazy>
<span class=by>karroffel</span></div><span class=date data-post-date="2018-05-07 00:00:00 +0000">7 May 2018</span></div><div class=tags><a href=/blog/progress-report><div class="tag active">Progress Report</div></a></div></div><div class="card card-warning"><p>This article is from <strong>May 2018</strong>, some of its contents might be outdated and no longer accurate.<br>You can find up-to-date information about the engine in the <a href=https://docs.godotengine.org/en/stable/>official documentation</a>.</div><div class=article-body><h2 id=introduction>Introduction</h2><p>The progress of last month was largely defined by stabilizing the 3D renderer with many smaller fixes, but work on the PRB side of things has begun and the GDNative system also saw some quality-of-life changes again, with improvements to the GDNativeLibrary resource as well as an API to provide safe type-casting in NativeScript.<h2 id=roadmap>Roadmap</h2><h4 id=done-april-2018>Done April 2018</h4><ul><li>CPU-calculated skeletal animations<li>stabilize 3D rendering (unshaded workflow)<li>implement skybox rendering<li>NativeScript global typetags for safe casts<li>GDNativeLibrary improvements<li>godot-rust low-level registering PR</ul><h4 id=planned-may-2018>Planned May 2018</h4><ul><li>enviroment relections + roughness<li>implement BRDF<li>add hardware support for skeletal animations<li>C++ bindings method argument checking<li>improve C++ bindings compilation workflow<li>resolve binary compatibility breakage issue with GDNative</ul><h2 id=details-about-work-in-april-2018>Details about work in April 2018</h2><h3 id=cpu-calculated-skeletal-animations>CPU-calculated skeletal animations</h3><p>A skeleton in computer graphics is usually a tree-structure of bones, where each bone is either a root bone without a parent, or it has a parent. Each bone can also have a transform. A configuration of bone transforms creates a <em>pose</em>.<p>In order to deform the mesh according to the bone transforms, each vertex (generally “point of a triangle”) can be influenced by up to 4 bones. The actual deformation usually happens in the <em>vertex shader</em>, where the bone transforms get looked up from a <em>texture</em>. (In rendering, textures are used for sooo many things. Everything is a texture if you’re brave enough)<p>Because the new OpenGL ES 2.0 backend is supposed to run on old hardware, there are some problems with hardware support for that: not all GPUs allow textures to be used in vertex shaders.<p>In Godot 2.1, <a href=https://github.com/godotengine/godot/blob/f8c36e226686dd5c8c95bfeca2dd8b6a118b40d2/drivers/gles2/rasterizer_gles2.cpp#L5136>this was solved</a> by having copies of the meshdata, then modifying the mesh itself with the bone transform information.<p>I chose to go a different route that uses less memory (but might cause more cache misses in the vertex shader):
the bone transforms for each vertex are stored in a <a href=https://github.com/karroffel/godot/blob/a0d0404cf397362152fe75d3aa221ac1c80a0e0d/drivers/gles2/rasterizer_storage_gles2.cpp#L3179>separate buffer</a>, this buffer gets <a href=https://github.com/karroffel/godot/blob/gles2/drivers/gles2/rasterizer_scene_gles2.cpp#L548>filled</a> with the new transforms before the element gets drawn.<p>So instead of looking up the transforms in the vertex shader from a texture, the final, already correctly interpolated transposed transform gets passed as 3 <code class="language-plaintext highlighter-rouge">vec4</code> to the shader and then <a href=https://github.com/karroffel/godot/blob/a0d0404cf397362152fe75d3aa221ac1c80a0e0d/drivers/gles2/shaders/scene.glsl#L99-L107>applied to the local model matrix</a> (The model matrix does things like translation, rotation and scale of the object).<p>This approach of dealing with skeletons works on all relevant hardware, but it is quite CPU intensive, so in future, a runtime check will be made to check if vertex shader texture lookup is supported, in that case a faster, hardware accelerated version will be used.<p><img src=/storage/app/uploads/public/5af/068/e71/5af068e717da7497159957.gif alt=poongoon_throw_animation_gles2.gif><h3 id=stabilize-3d-rendering-unshaded-workflow>stabilize 3D rendering (unshaded workflow)</h3><p>I spent quite a lot of days fixing up things to make the existing 3D rendering more stable and usable. Those things were usually quite small, but it did add up in the end. Because it’s all relatively minor stuff, here’s short list of the things I did instead of detailed destriptions:<ul><li>make shaders more lightweight by using more preprocessor defines<li>added TIME uniform to all “scriptable” shaders<li>added ALPHA_SCISSOR support for spatial shaders<li>made separate alpha pass use custom blending modes<li>shader language compatibility fixes<li>SCREEN_UV support for both canvas and spatial shaders<li>use S3TC compression when available<li>use ETC1 compression when available</ul><p>I could say more things about those changes, but for sake of brevity (and laziness o.o) I will keep this section a bit shorter. If there’s interest in how those things are implemented, most of those changes are in separate commits, so a look through the git log should be enough to get you to the code.<h3 id=implement-skybox-rendering>implement skybox rendering</h3><p>The first step I take towards implement physically based rendering is to get enviromental reflections showing on objects. Environmental reflections are visible the most with non-rough materials that reflect how the world around the object looks like. Examples could be metal spoons, plastic mugs, things like that.<p>Example of environmental reflections (not Godot GLES2, taken from <a href=https://upload.wikimedia.org/wikipedia/commons/1/19/Cube_mapped_reflection_example_2.JPG>wikipedia</a>)
<img src=https://upload.wikimedia.org/wikipedia/commons/1/19/Cube_mapped_reflection_example_2.JPG alt=https://upload.wikimedia.org/wikipedia/commons/1/19/Cube_mapped_reflection_example_2.JPG><p>The image type used for such a texture is a <a href=https://en.wikipedia.org/wiki/Cube_mapping>cube map</a>. A cube map consist of 6 sub-images, each representing what could be described as what would be seen on each side of a glass cube out of which inside the observer looks. Or shot: it can be used for 360° images.<p>If an object is 100% reflective, the image of the surrounding sky will be projected onto its surface. If the material is more <em>rough</em> then a more blurred version fo the sky will be used. This is how the very basics of roughness in PBR can be implemented.<p>On the quest of achieving this, a sky texture has to be loaded first, then it has to be displayed as the actual sky (not a necessity, but it looks weird if you have a reflection without a sky), after that it can be mapped onto object’s surfaces.<p>With the GLES2 backend I reached the “display as sky” part, which looks like this:<p><img src=/storage/app/uploads/public/5af/0de/517/5af0de517bade574973710.png alt="Screenshot from 2018-04-30 19-50-16.png"><p>I already started work on mapping the sky on object’s surfaces, but that’s for the next progress report :)<h3 id=nativescript-global-typetags-for-safe-casts>NativeScript global typetags for safe casts</h3><p>One cruicial missing feature in the NativeScript API was the ability to perform proper type checks of Objects and script classes.<p>In the initial <a href=https://github.com/godotengine/godot/pull/16514>NativeScript 1.1 extension</a> support for script type-tags was added. Those could be used to ensure that a given script is actually from the same library/language and class you expected it to be. The problem is that this functionality stopped there: it can only test for script classes.<p>The functionality of adding <em>global type tags</em> <a href=https://github.com/godotengine/godot/pull/17980>was added</a> so that <em>every</em> object can be asked for a type and can be safely checked and casted.<p>The <a href=https://github.com/GodotNativeTools/godot-cpp/tree/nativescript-1.1>C++ bindings</a> already implement this on the <code class="language-plaintext highlighter-rouge">nativescript-1.1</code> branch, so following code will now work:<div class="language-cpp highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=n>Object</span> <span class=o>*</span><span class=n>o</span> <span class=o>=</span> <span class=n>get_the_object</span><span class=p>();</span>

<span class=n>Reference</span> <span class=o>*</span><span class=n>r</span> <span class=o>=</span> <span class=n>Object</span><span class=o>::</span><span class=n>cast_to</span><span class=o>&lt;</span><span class=n>Reference</span><span class=o>&gt;</span><span class=p>(</span><span class=n>o</span><span class=p>);</span>

<span class=k>if</span> <span class=p>(</span><span class=n>r</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Godot</span><span class=o>::</span><span class=n>print</span><span class=p>(</span><span class=s>"I got a reference!"</span><span class=p>);</span>
<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>Godot</span><span class=o>::</span><span class=n>print</span><span class=p>(</span><span class=s>"The object was not a reference :("</span><span class=p>);</span>
<span class=p>}</span>

</code></pre></div></div><h3 id=gdnativelibrary-improvements>GDNativeLibrary improvements</h3><p>A <code class="language-plaintext highlighter-rouge">GDNativeLibrary</code> is a resource that contains the needed information about a native library. It is backed by a <a href=http://docs.godotengine.org/en/3.0/classes/class_configfile.html><code class="language-plaintext highlighter-rouge">ConfigFile</code></a> which is nice for manual editing. Until lately, a GDNativeLibrary could only be properly created by loading it from a file stored on disk, which made <em>programmatically</em> creating them a lot more confusing and not-nice.<p>Another <strong>huge</strong> problem that was caused by this behavior is that GDNativeLibrary resources could not properly be embedded in other resources causing many problems with the existing Godot workflow.<p>This problem was solved by adding proper de-/serialization so that it can be used as a sub-resource, as well as adding a way to set a ConfigFile directly, without having to store it on disk.<p>The PR for that can be found <a href=https://github.com/godotengine/godot/pull/17965>here</a>, it’s rather small but an immense improvement to the usability of many GDNative applications.<h3 id=godot-rust-low-level-registering-pr>godot-rust low-level registering PR</h3><p>As mentioned in the <a href=https://godotengine.org/article/gles2-and-gdnative-progress-report-4>last progress report</a>, some work on the <a href=https://github.com/GodotNativeTools/godot-rust><code class="language-plaintext highlighter-rouge">godot-rust</code></a> repository has been prepared but not PR’d to the main repository yet. This is what I did, so <a href=https://github.com/GodotNativeTools/godot-rust/pull/81>here’s the PR</a> which got merged recently! This wasn’t too big of a change, but I hope that the bindings, which are under more active development (but help is still appreciated :P ), will become more transparent.<h2 id=future>Future</h2><p>The C++ bindings are getting to a place where they are more safe to use and resemble code as you would find it in the engine a lot more. As there seems to be a lot of community interest in the Rust bindings, I will try to get more involved with those.<p>For the graphics side of things, I can’t wait to get roughness working properly, along with other things that I learned more about in the last few weeks. PBR is a pretty interesting topic and it’s awesome to have the opportunity to explore this in depth thanks to all the Patrons &lt;3<h2 id=seeing-the-code>Seeing the code</h2><p>If you are interested in the GLES2 related code, you can see all the commits in my <a href=https://github.com/karroffel/godot/tree/gles2>fork</a> on GitHub. Other contributions are linked in the sections above.</div></div></article></div><link rel=stylesheet href=/assets/css/anchor-link.css?1><link rel=stylesheet href=/assets/css/article-cards.css?2><script src=/assets/js/anchor-link.js></script>
<script>document.addEventListener('DOMContentLoaded',()=>{window.applyAnchorLinks('.article-body'),document.querySelectorAll('.article-cover img, .article-body img').forEach(b=>{if(b.classList.contains('lightbox-ignore'))return;const a=document.createElement('a');a.href=b.src,a.classList.add('lightbox'),a.dataset.group='article',b.parentNode.appendChild(a),a.appendChild(b)})})</script></main><footer><div class="container flex footer-container"><div id=copyright><p>© 2007-2024 Juan Linietsky, Ariel Manzur and <a href=https://github.com/godotengine/godot/blob/master/AUTHORS.md target=_blank rel=noopener>contributors</a>.<br>Hosted by the <a href=https://godot.foundation/ target=_blank rel=noopener>Godot Foundation</a>.<br>Website <a href=https://github.com/godotengine/godot-website target=_blank rel=noopener>source code on GitHub</a>.</div><div id=sitemap><ul class=sitemap-group><li><strong>Get Godot</strong><li><a href=/download/windows/ class=set-os-download-url>Download</a><li><a href=/download/archive/>Release Archive</a><li><a href=https://editor.godotengine.org/releases/latest/>Web Editor</a><li>&nbsp;<li><strong>Public Relations</strong><li><a href=/blog/>Blog</a><li><a href=/community/>Communities and Events</a><li><a href=/press/>Press Kit</a></ul><ul class=sitemap-group><li><strong>About Godot</strong><li><a href=/features/>Features</a><li><a href=/showcase/>Showcase</a><li><a href=/education/>Education</a><li><a href=/license/>License</a><li><a href=/code-of-conduct/>Code of Conduct</a><li><a href=/privacy-policy/>Privacy Policy</a><li><a href=https://fund.godotengine.org>Donate</a></ul><ul class=sitemap-group><li><strong>Project Team</strong><li><a href=/governance/>Governance</a><li><a href=/teams/>Teams</a><li>&nbsp;<li><strong>Extra Resources</strong><li><a href=https://godotengine.org/asset-library/asset>Asset Library</a><li><a href=https://docs.godotengine.org>Documentation</a><li><a href=https://github.com/godotengine>Code Repository</a></ul></div><div id=social class=dark-desaturate><h4 class=text-right><a href=/contact/>Contact us</a></h4><div class="flex justify-space-between" style=gap:3px><a href=https://github.com/godotengine target=_blank rel=noopener><img src=/assets/footer/github_logo.svg width=32 height=32 alt=GitHub></a>
<a href=https://mastodon.gamedev.place/@godotengine target=_blank rel=noopener><img src=/assets/footer/mastodon_logo.svg width=32 height=32 alt=Mastodon></a>
<a href=https://twitter.com/godotengine target=_blank rel=noopener><img src=/assets/footer/twitter_logo.svg width=32 height=32 alt=Twitter></a>
<a href=https://www.facebook.com/groups/godotengine/ target=_blank rel=noopener><img src=/assets/footer/facebook_logo.svg width=32 height=32 alt=Facebook></a>
<a href=https://www.reddit.com/r/godot target=_blank rel=noopener><img src=/assets/footer/reddit_logo.svg width=32 height=32 alt=Red​dit></a>
<a href=/rss.xml target=_blank rel=noopener><img src=/assets/footer/feed_logo.svg width=32 height=32 alt="RSS feed"></a></div></div></div></footer><script defer src=/assets/js/tobii.min.js></script>
<script defer src=/assets/js/highlight.min.js?1></script>
<script defer src=/assets/js/highlight.gdscript.min.js?1></script>
<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('pre code').forEach(a=>{hljs.highlightBlock(a)}),document.querySelectorAll('[data-post-date]').forEach(a=>{Date.parse(a.dataset.postDate)>Date.now()-1e3*60*60*48&&a.classList.add("post-recent-highlight")}),new Tobii({zoom:!1});const a=document.querySelectorAll('.set-os-download-url');for(let b=0;b<a.length;b++){const c=a[b];let e='download';'version'in c.dataset&&c.dataset.version==='3'&&(e='download/3.x');let d='windows';navigator.platform.indexOf('Mac')!==-1?d='macos':navigator.platform.indexOf('Linux')!==-1&&(d='linux'),c.href=`/${e}/${d}/`}})</script>