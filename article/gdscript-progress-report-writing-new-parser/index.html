<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Godot Engine"><meta name=description content="Showing the work for the new GDScript parser, why it is done and how it improves over the old one. Also show a bit of new features."><meta name=theme-color content="#3d8fcc"><meta property="og:site_name" content="Godot Engine"><meta property="og:url" content="https://godotengine.org/article/gdscript-progress-report-writing-new-parser/"><meta name=twitter:site content="@godotengine"><meta property="og:title" content="GDScript progress report: Writing a new parser"><meta property="og:description" content="Showing the work for the new GDScript parser, why it is done and how it improves over the old one. Also show a bit of new features."><meta property="og:image" content="https://godotengine.org/storage/app/uploads/public/5ed/43c/e24/5ed43ce245f10218039510.png"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><title>GDScript progress report: Writing a new parser</title><link rel=alternate type=application/rss+xml title="Godot News" href=/rss.xml><link rel=icon href=/assets/favicon.png sizes=any><link rel=icon href=/assets/favicon.svg type=image/svg+xml><link rel=stylesheet href=/assets/css/main.css?112><link rel=stylesheet href=/assets/css/tobii.min.css><link rel=preload as=font href=/assets/fonts/Montserrat-Bold.woff2 crossorigin><link rel=preload as=font href=/assets/fonts/Montserrat-ExtraBold.woff2 crossorigin><link rel=me href=https://mastodon.gamedev.place/@godotengine><input type=checkbox id=nav_toggle_cb><header><div class="container flex align-center"><div id=nav_head><a href=/ id=logo-link><img class=nav-logo src=/assets/logo.svg width=136 height=48 alt="Godot Engine">
<img class="nav-logo dark-logo" src=/assets/logo_dark.svg width=136 height=48 alt="Godot Engine"></a>
<label for=nav_toggle_cb id=nav_toggle_btn><img src=/assets/icons/hamburger.svg width=24 height=24 alt="Main menu"></label></div><nav id=nav><ul class=left><li><a href=/features/>Features</a><li class=only-on-mobile><a href=/showcase/>Showcase</a><li><a href=/blog/>Blog</a><li><a href=/community/>Community</a><li><a href=/contact/>About</a><li><a href=https://godotengine.org/asset-library/asset>Assets</a></ul><ul class=right><li><a href=/download/windows/ class=set-os-download-url>Download</a><li><a href=https://docs.godotengine.org>Docs</a><li><a href=https://docs.godotengine.org/en/stable/community/contributing/index.html>Contribute</a><li class=fund><a href=https://fund.godotengine.org>❤&#xFE0E; Donate</a></ul></nav></div></header><main><style>body{background-color:var(--background-color)}h1{margin-bottom:8px;margin-top:32px}:not(pre)>code{background:var(--code-background-color);padding:1px 4px;font-size:.95em;border-radius:3px}pre{background:var(--codeblock-background-color);color:var(--codeblock-color)}pre code{display:block;overflow-x:auto;padding:.5em}.date-big{line-height:2;margin-left:32px}article{background-color:var(--base-color);box-shadow:0 3px 2px rgba(0,0,0,.15)}figure{margin:0}figure img{margin:0}article img,article video{max-width:100%;height:auto;display:block;margin:auto;margin-top:16px;margin-bottom:16px}article h1{margin-top:64px}article h2,article h3,article h4{margin-top:42px}.article-info{display:flex;flex-direction:column;gap:8px}.article-metadata{display:flex;gap:24px;align-items:center;font-family:var(--header-font-family);margin-bottom:12px}@media(max-width:900px){.article-metadata{flex-direction:column;align-items:flex-start;gap:16px}}.article-author{color:var(--base-color-text-subtitle-date);font-weight:700;font-size:18px;flex-grow:1;display:flex;gap:12px;align-items:center}.article-author .avatar{border-radius:100%;margin:0}.article-author .by{color:var(--base-color-text-subtitle)}.article-metadata .date{color:var(--base-color-text-subtitle-date)}.article-metadata .date.post-recent-highlight{color:var(--post-recent-highlight-color);opacity:.8}.article-metadata .date.post-recent-highlight::after{font-size:80%;content:"NEW";border:2px solid var(--post-recent-highlight-color);padding:2px 3px;margin-left:8px}.tag.active{filter:saturate(.75)}@media screen and (min-width:900px){article .content{width:70%;margin:auto}}@media(max-width:900px){body{background-color:var(--base-color)}article{background-color:initial;box-shadow:none}article img:first-child,article video:first-child{max-width:100%}}</style><link rel=stylesheet href=/assets/css/highlight.obsidian.min.css><div class=container><article class=padded><div class="content article-container"><figure class=article-cover><img src=/storage/app/uploads/public/5ed/43c/e24/5ed43ce245f10218039510.png title alt=" " class=rounded-lg style=width:100%;height:auto;background-color:initial></figure><div class=article-info><h1>GDScript progress report: Writing a new parser</h1><div class=article-metadata><div class=article-author><span>By:</span>
<img class=avatar width=25 height=25 src=/assets/images/authors/vnen.webp alt="George Marques" loading=lazy>
<span class=by>George Marques</span></div><span class=date data-post-date="2020-06-01 11:37:58 +0000">1 June 2020</span></div><div class=tags><a href=/blog/progress-report><div class="tag active">Progress Report</div></a></div></div><div class="card card-warning"><p>This article is from <strong>June 2020</strong>, some of its contents might be outdated and no longer accurate.<br>You can find up-to-date information about the engine in the <a href=https://docs.godotengine.org/en/stable/>official documentation</a>.</div><div class=article-body><p>As you might be aware right now I’m currently working on revamping the GDScript compiler. After finishing the tokenizer in the last report, I’ve been working on the new parser.<p>The main point to bring in this rewrite is to make a bit more “textbook-like” as mentioned in the previous article, so I split grammar production in different functions. Before we had big <code class="language-plaintext highlighter-rouge">switch</code> statements with many cases to parse the code, now we delegate the work to specific functions. This makes it easier to find where a particular piece of code is.<p><em>See other articles in this Godot 4.0 GDScript series:</em><ol><li><a href=https://godotengine.org/article/gdscript-progress-report-writing-tokenizer>GDScript progress report: Writing a tokenizer</a><li>(you are here) <a href=https://godotengine.org/article/gdscript-progress-report-writing-new-parser>GDScript progress report: Writing a new parser</a><li><a href=https://godotengine.org/article/gdscript-progress-report-type-checking-back>GDScript progress report: Type checking is back</a><li><a href=https://godotengine.org/article/gdscript-progress-report-new-gdscript-now-merged>GDScript progress report: New GDScript is now merged</a><li><a href=https://godotengine.org/article/gdscript-progress-report-typed-instructions>GDScript progress report: Typed instructions</a><li><a href=https://godotengine.org/article/gdscript-progress-report-feature-complete-40>GDScript progress report: Feature-complete for 4.0</a></ol><h2 id=less-lookahead>Less lookahead</h2><p>The previous parser relied on the tokenizer ability to buffer tokens to ask for a few the next (and sometimes the previous) tokens in order to decide what the code means. The new tokenizer lacks this ability on purpose to make sure we can use the bare minimum of a lookahead to parse the code.<p>Minimizing lookahead means the code is easier to parse. If we were to introduce a new syntax for a feature, now we have to make sure it does not increase the complexity of the parser by demanding too much tokens at once.<p>The new parser only stores the current and previous token (or the current and the next if you look it in another way). It means that GDScript only needs one token of lookahead to be fully parsed. This takes us to a simpler language design and implementation.<h2 id=a-pratt-parser-for-expressions>A Pratt parser for expressions</h2><p>Those who are familiar with programming language implementation will know that parsing expressions is always tricky. When you consider precedence of operators, and that an arbitrary expression can be left operand of a, say, <code class="language-plaintext highlighter-rouge">+</code> operator, it can get very tricky to decide how to build the parse tree.<p>There are different solutions to this but I like the <a href=https://journal.stuffwithstuff.com/2011/03/19/pratt-parsers-expression-parsing-made-easy/>Pratt parsing</a> for its simplicity. It consists in a function table in which the index is the token type. This means that deciding which parser function to call is just a lookup based on the current token.<p><img src=/storage/app/media/gdscript-pratt-table.png alt><p>This makes it very easy to see—and change—the precedence of every operators. The functions do have to share the signature, but it’s usually not a big deal since most of them aren’t called outside the expression parser.<h2 id=multiple-error-detection>Multiple error detection</h2><p>Also mentioned in the previous article, the idea is to show multiple errors at once so you don’t need to fix one to discover the next. The new parser has support to store an arbitrary number of errors.<p>When it finds something unexpected, the parser enters <em>“panic mode”</em>. While in this mode, it will ignore every token until it finds one that can only be the beginning of a statement. At this point, it can leave the panic mode and go back to regular parsing. While this can cause cascading errors due to missing or extra token, it can show errors in different parts of the file at once.<p>This will also help completion since the parser won’t need to stop on the first error and can check what’s next in the file to also suggest.<h2 id=pretty-tree-printer>Pretty tree printer</h2><p>As I did with the tokenizer, I added a print mode to replace the old <code class="language-plaintext highlighter-rouge">gd_parser</code> test. It prints the tree in an unambiguous readable way so problems with parsing can be detected.<p>So a script like this:<div class="language-gdscript highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>class_name</span> <span class=n>MyClass</span> <span class=k>extends</span> <span class=n>Node2D</span>

<span class=k>const</span> <span class=n>SPEED</span> <span class=o>=</span> <span class=mi>200</span>
<span class=err>@</span><span class=k>export</span> <span class=k>var</span> <span class=n>player_name</span> <span class=o>=</span> <span class=s2>"Vladimir"</span>

<span class=k>func</span> <span class=nf>_ready</span><span class=p>():</span>
    <span class=o>$</span><span class=n>Button</span><span class=o>.</span><span class=n>button_up</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>_on_button_pressed</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>"Ready!"</span><span class=p>)</span>

<span class=k>func</span> <span class=nf>_on_button_pressed</span><span class=p>():</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>"Player is </span><span class=se>\"</span><span class=si>%s</span><span class=se>\"</span><span class=s2>"</span> <span class=o>%</span> <span class=n>player_name</span><span class=p>)</span>

<span class=k>func</span> <span class=nf>_process</span><span class=p>(</span><span class=n>delta</span><span class=p>):</span>
    <span class=o>$</span><span class=n>Body</span><span class=o>.</span><span class=n>move</span><span class=p>(</span><span class=n>delta</span> <span class=o>*</span> <span class=n>SPEED</span><span class=p>)</span>
</code></pre></div></div><p>Will be printed like this:<div class="language-plaintext highlighter-rouge"><div class=highlight><pre class=highlight><code>Class MyClass Extends Node2D :
|   Constant SPEED
|   |   = 200
|   @export ()
|   Variable player_name
|   |   = "Vladimir"
|   Function _ready(  ) :
|   |   $Button.button_up.connect( _on_button_pressed )
|   |   print( "Ready!" )
|   Function _on_button_pressed(  ) :
|   |   print( ("Player is "%s"" % player_name) )
|   Function _process( delta ) :
|   |   $Body.move( (delta * SPEED) )
</code></pre></div></div><h2 id=annotations>Annotations</h2><p>Shown briefly in the previous example, I implemented annotations as outlined in <a href=https://github.com/godotengine/godot-proposals/issues/828>GIP #828</a>. Those are meant to replace a few keywords and improve the ability to add new integrations without having to create new keywords and big changes in the parser.<p>This also means that the old <code class="language-plaintext highlighter-rouge">export</code> syntax is now extinct in favor of specific annotations. This makes it in general easy to remember and understand and don’t require much effort in the GDScript implementation, since their arguments are the same as expected in the internal hint strings.<p>There will be an <a href=https://github.com/godotengine/godot-docs/pull/3623>update to the documentation</a> to explain the new way.<h2 id=await-replaces-yield><code class="language-plaintext highlighter-rouge">await</code> replaces <code class="language-plaintext highlighter-rouge">yield</code></h2><p>The old <code class="language-plaintext highlighter-rouge">yield</code> syntax was a bit convoluted complicated to understand, forcing you to deal with function states. It was especially harder to understand given it did the opposite of other languages do with the same keyword.<p>The <code class="language-plaintext highlighter-rouge">await</code> syntax can be used to wait for signals or coroutines alike:<div class="language-gdscript highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>func</span> <span class=nf>coroutine</span><span class=p>():</span>
    <span class=n>await</span> <span class=o>$</span><span class=n>Button</span><span class=o>.</span><span class=n>button_up</span> <span class=c1># Will suspend the function and resume when the button is pressed.</span>
    <span class=k>return</span> <span class=bp>true</span>

<span class=k>func</span> <span class=nf>_ready</span><span class=p>():</span>
    <span class=k>var</span> <span class=n>result</span> <span class=o>=</span> <span class=n>await</span> <span class=n>coroutine</span><span class=p>()</span> <span class=c1># Will suspend the function and wait for the coroutine result.</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span> <span class=c1># true</span>
</code></pre></div></div><h2 id=breaking-things-to-make-them-anew>Breaking things to make them anew</h2><p>I wanted to make this new parser working with the current system sooner rather than later. So I amended the dependencies on the old parser and tokenizer to use the new one. Since this is rather time consuming, a lot of things were disabled in the meantime.<p>I do mention what’s missing in my <a href=https://github.com/godotengine/godot/pull/39093>initial Pull Request</a> but here is a shortlist:<ul><li>Type checking.<li>Code completion.<li>Warnings.<li>Language server.<li><code class="language-plaintext highlighter-rouge">setget</code> (will be replaced by <a href=https://github.com/godotengine/godot-proposals/issues/844>properties</a>).<li>Some optimizations.</ul><p>This will be fixed in the next steps<h2 id=future>Future</h2><p>There’s still a long road ahead to make GDScript a better language in general. The next step is to read the type checks so the systems that depend on it can also be reactivated. Hopefully the new type checker will be more precise than the previous one (I learned a lot since then). And it will allow use of some new features like typed arrays.</div></div></article></div><link rel=stylesheet href=/assets/css/anchor-link.css?1><link rel=stylesheet href=/assets/css/article-cards.css?2><script src=/assets/js/anchor-link.js></script>
<script>document.addEventListener('DOMContentLoaded',()=>{window.applyAnchorLinks('.article-body'),document.querySelectorAll('.article-cover img, .article-body img').forEach(b=>{if(b.classList.contains('lightbox-ignore'))return;const a=document.createElement('a');a.href=b.src,a.classList.add('lightbox'),a.dataset.group='article',b.parentNode.appendChild(a),a.appendChild(b)})})</script></main><footer><div class="container flex footer-container"><div id=copyright><p>© 2007-2024 Juan Linietsky, Ariel Manzur and <a href=https://github.com/godotengine/godot/blob/master/AUTHORS.md target=_blank rel=noopener>contributors</a>.<br>Hosted by the <a href=https://godot.foundation/ target=_blank rel=noopener>Godot Foundation</a>.<br>Website <a href=https://github.com/godotengine/godot-website target=_blank rel=noopener>source code on GitHub</a>.</div><div id=sitemap><ul class=sitemap-group><li><strong>Get Godot</strong><li><a href=/download/windows/ class=set-os-download-url>Download</a><li><a href=/download/archive/>Release Archive</a><li><a href=https://editor.godotengine.org/releases/latest/>Web Editor</a><li>&nbsp;<li><strong>Public Relations</strong><li><a href=/blog/>Blog</a><li><a href=/community/>Communities and Events</a><li><a href=/press/>Press Kit</a></ul><ul class=sitemap-group><li><strong>About Godot</strong><li><a href=/features/>Features</a><li><a href=/showcase/>Showcase</a><li><a href=/education/>Education</a><li><a href=/license/>License</a><li><a href=/code-of-conduct/>Code of Conduct</a><li><a href=/privacy-policy/>Privacy Policy</a><li><a href=https://fund.godotengine.org>Donate</a></ul><ul class=sitemap-group><li><strong>Project Team</strong><li><a href=/governance/>Governance</a><li><a href=/teams/>Teams</a><li>&nbsp;<li><strong>Extra Resources</strong><li><a href=https://godotengine.org/asset-library/asset>Asset Library</a><li><a href=https://docs.godotengine.org>Documentation</a><li><a href=https://github.com/godotengine>Code Repository</a></ul></div><div id=social class=dark-desaturate><h4 class=text-right><a href=/contact/>Contact us</a></h4><div class="flex justify-space-between" style=gap:3px><a href=https://github.com/godotengine target=_blank rel=noopener><img src=/assets/footer/github_logo.svg width=32 height=32 alt=GitHub></a>
<a href=https://mastodon.gamedev.place/@godotengine target=_blank rel=noopener><img src=/assets/footer/mastodon_logo.svg width=32 height=32 alt=Mastodon></a>
<a href=https://twitter.com/godotengine target=_blank rel=noopener><img src=/assets/footer/twitter_logo.svg width=32 height=32 alt=Twitter></a>
<a href=https://www.facebook.com/groups/godotengine/ target=_blank rel=noopener><img src=/assets/footer/facebook_logo.svg width=32 height=32 alt=Facebook></a>
<a href=https://www.reddit.com/r/godot target=_blank rel=noopener><img src=/assets/footer/reddit_logo.svg width=32 height=32 alt=Red​dit></a>
<a href=/rss.xml target=_blank rel=noopener><img src=/assets/footer/feed_logo.svg width=32 height=32 alt="RSS feed"></a></div></div></div></footer><script defer src=/assets/js/tobii.min.js></script>
<script defer src=/assets/js/highlight.min.js?1></script>
<script defer src=/assets/js/highlight.gdscript.min.js?1></script>
<script>document.addEventListener('DOMContentLoaded',()=>{document.querySelectorAll('pre code').forEach(a=>{hljs.highlightBlock(a)}),document.querySelectorAll('[data-post-date]').forEach(a=>{Date.parse(a.dataset.postDate)>Date.now()-1e3*60*60*48&&a.classList.add("post-recent-highlight")}),new Tobii({zoom:!1});const a=document.querySelectorAll('.set-os-download-url');for(let b=0;b<a.length;b++){const c=a[b];let e='download';'version'in c.dataset&&c.dataset.version==='3'&&(e='download/3.x');let d='windows';navigator.platform.indexOf('Mac')!==-1?d='macos':navigator.platform.indexOf('Linux')!==-1&&(d='linux'),c.href=`/${e}/${d}/`}})</script>